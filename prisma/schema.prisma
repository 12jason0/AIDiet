// schema.prisma
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                  Int      @id @default(autoincrement())
  name                String
  email               String   @unique
  passwordHash        String
  gender              String?
  age                 Int?
  goal                String? // diet, muscle_gain, low_sugar 등
  calorie_target      Float?
  allergies           Json? // ✅ String[] 대신 Json 사용
  dislike_ingredients Json? // ✅ String[] 대신 Json 사용
  createdAt           DateTime @default(now())

  // 관계
  mealPlans          MealPlan[]
  recommendationLogs RecommendationLog[]
  cart               Cart?
}

model Nutrition {
  id         Int         @id @default(autoincrement())
  kcal       Float?
  protein    Float?
  fat        Float?
  carbs      Float?
  sugar      Float?
  fiber      Float?
  sodium     Float?
  ingredient Ingredient?
}

model Ingredient {
  id                Int                @id @default(autoincrement())
  name              String
  category          String // protein, vegetable, grain, etc
  image_url         String?
  nutrition_id      Int?               @unique
  nutrition         Nutrition?         @relation(fields: [nutrition_id], references: [id])
  recipeIngredients RecipeIngredient[]
  cartItems         CartItem[]
}

model Recipe {
  id                 Int                 @id @default(autoincrement())
  name               String
  description        String?             @db.Text
  cooking_time       Int? // minutes
  difficulty         String?
  image_url          String?
  instructions       Json? // ✅ String[] 대신 Json 사용
  recipeIngredients  RecipeIngredient[]
  mealPlanRecipes    MealPlanRecipe[]
  recommendationLogs RecommendationLog[]
}

model RecipeIngredient {
  id            Int        @id @default(autoincrement())
  recipe_id     Int
  ingredient_id Int
  amount        Float?
  unit          String?
  recipe        Recipe     @relation(fields: [recipe_id], references: [id], onDelete: Cascade)
  ingredient    Ingredient @relation(fields: [ingredient_id], references: [id], onDelete: Cascade)

  @@index([recipe_id])
  @@index([ingredient_id])
}

model MealPlan {
  id      Int              @id @default(autoincrement())
  user_id Int
  date    DateTime
  type    String // breakfast, lunch, dinner, snack
  user    User             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  recipes MealPlanRecipe[]

  @@index([user_id])
  @@index([date])
}

model MealPlanRecipe {
  id          Int      @id @default(autoincrement())
  mealplan_id Int
  recipe_id   Int
  mealPlan    MealPlan @relation(fields: [mealplan_id], references: [id], onDelete: Cascade)
  recipe      Recipe   @relation(fields: [recipe_id], references: [id], onDelete: Cascade)

  @@index([mealplan_id])
  @@index([recipe_id])
}

model RecommendationLog {
  id            Int      @id @default(autoincrement())
  user_id       Int
  recipe_id     Int
  recommendedAt DateTime @default(now())
  liked         Boolean? @default(false)
  user          User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  recipe        Recipe   @relation(fields: [recipe_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([recipe_id])
}

model Cart {
  id        Int        @id @default(autoincrement())
  user_id   Int        @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  items     CartItem[]
}

model CartItem {
  id            Int        @id @default(autoincrement())
  cart_id       Int
  ingredient_id Int
  quantity      Float?
  unit          String?
  cart          Cart       @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  ingredient    Ingredient @relation(fields: [ingredient_id], references: [id], onDelete: Cascade)

  @@index([cart_id])
  @@index([ingredient_id])
}
